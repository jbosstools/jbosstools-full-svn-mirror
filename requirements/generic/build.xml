<project default="build.driver">
	
	<property name="requirement" value="${requirement.name}"/>
	<property name="driver.properties" value="${basedir}/build.properties" />
	<loadproperties srcFile="${driver.properties}"/>
	
	<property name="driver.dest" value="${requirement.download.root}/${requirement}"/>
	
	<target name="init" />
	
	<target name="build.requirement" depends="build.driver" />

	<target name="unpack.requirement" depends="unzip.archive" />	
	
	<target name="download.requirement" depends="download.archive" />
	
	<target name="build.driver" depends="unzip.archive" />	
	
	<target name="unzip.archive" depends="download.archive">
		<property name="ext" value="zip"/>
		<echo level="debug">Unpacking ${driver.dest}/${build.archive} to ${unzip.dest}</echo>
		<if>
			<available file="${driver.dest}/${build.archive}" />
			<then>
				<antcall target="unpack-${ext}" />
				<tstamp/>
				<antcall target="post.unpack.requirement"/>
			</then>
		</if>
		
	</target>

	<target name="post.unpack.requirement">
	</target>
	
	<target name="unpack-tar.gz">
		<untar compression="gzip" src="${driver.dest}/${build.archive}" dest="${unzip.dest}"  />
	</target>
	
	<target name="unpack-zip">
		<unzip src="${driver.dest}/${build.archive}" dest="${unzip.dest}" />
	</target>
	
	<target name="check.archive" depends="init">
		<echo>Checking the requirement's archive ${build.archive}</echo>
		<if>
			<available file="${driver.dest}/${build.archive}" />
			<then>
				<if>
					<isset property="md5" />
					<then>
						<echo>Archive is downloaded and MD5 checksum is provided</echo>
						<echo level="verbose">Calcualting checksum for downloaded archive</echo>
						<checksum file="${driver.dest}/${build.archive}" property="current.md5"/>
						<echo level="verbose">${current.md5} calculated</echo>
						<echo level="verbose">${md5} provided</echo>
						<condition property="archive.exists" >
							<equals arg1="${current.md5}" arg2="${md5}"/>
						</condition>
						<if>
							<isset property="archive.exists" />
							<then>
								<echo>Downloaded archive is correct, download is not required</echo>
							</then>
							<else>
								<echo>Downloaded archive checksum is not correct, new download required</echo>
							</else>
						</if>
					</then>
					<else>
						<echo>Archive is downloaded and no MD5 checksum is provided</echo>
						<property name="archive.exists" value="true"/>
					</else>
				</if>
			</then>
			<else>
				<echo>Archive has not downloaded yet, download required</echo>
			</else>
		</if>
	</target>

	<target name="download.archive" depends="check.archive" unless="archive.exists">
		<if>
			<or>
				<equals arg1="${settings.offline}" arg2="true" />
				<equals arg1="${maven.test.skip}" arg2="true" />
				<equals arg1="${skipDownload}" arg2="true" />
			</or>
			<then>
				<echo>Skip download for ${build.uri}/${build.archive}</echo>
			</then>
			<else>
				<mkdir dir="${driver.dest}"/>
				<get taskname="download ${requirement}"
					src="${build.uri}/${build.archive}" 
					dest="${driver.dest}/${build.archive}" />
				<antcall target="post.download.requirement"/>
			</else>
		</if>
	</target>

	<target name="post.download.requirement">
	</target>	

</project>
