<project>
	<taskdef classpath="../../lib/ant-contrib.jar" resource="net/sf/antcontrib/antlib.xml"/>
	<path id="svn.classpath">
		<pathelement location="../../lib/svnant.jar"/>
		<pathelement location="../../lib/svnClientAdapter.jar"/>
		<pathelement location="../../lib/svnjavahl.jar"/>
		<pathelement location="../../lib/javasvn.jar"/>
		<pathelement location="../../lib/jsch-0.1.20.jar"/>
	</path>
	
	<taskdef classpathref="svn.classpath"  resource="svntask.properties"/>
	
	<property file="../global.properties"/>
	<property file="build.properties"/>
	
	<import file="../common/scp.xml"/>

	<property name="labs-dir" value="labs.jboss.com"/>
	<property name="downloads-dir" value="${labs-dir}/downloads"/>
	
	<target name="fetch-builds-xml">
		<get src="${jbosside.download.url}/builds/builds.xml" dest="${labs-dir}/builds.xml"/>
	</target>
	
	<target name="generate-top-level-downloads-xml" depends="fetch-builds-xml">
		<style destdir="." includes="${labs-dir}/builds.xml" extension=".downloads.xml" style="${labs-dir}/downloads.xsl" force="true"/>
		
		<move file="${labs-dir}/builds.downloads.xml" tofile="${labs-dir}/downloads/downloads.xml"/>
	</target>
	
	<target name="generate-sections-downloads-xml" depends="generate-top-level-downloads-xml">
		<for list="nightly,integration,development-release,stable-release" param="build-type">
			<sequential>
				<style destdir="." includes="${labs-dir}/builds.xml" extension=".@{build-type}.xml" style="${labs-dir}/downloads-section.xsl" force="true">
					<param name="build-type" expression="@{build-type}"/>
				</style>
				
				<move file="${labs-dir}/builds.@{build-type}.xml" tofile="${labs-dir}/downloads/@{build-type}/downloads.xml"/>
			</sequential>
		</for>
	</target>
	
	<target name="update-labs-downloads" depends="generate-sections-downloads-xml" if="enable.downloads.update">
		<property name="work-dir" value="${labs-dir}/work"/>
		<mkdir dir="${work-dir}"/>
		
		<svn javahl="false" username="${svn.username}" password="${svn.password}">
			<checkout url="${labs.url}"
				destPath="${work-dir}"/>
		</svn>
		
		<copy todir="${work-dir}">
			<fileset dir="${labs-dir}/downloads" includes="**/*"/>
		</copy>
		
		<tstamp>
			<format pattern="MM/dd/yyyy HH:mm" property="build-date"/>
		</tstamp>
		
		<svn javahl="false" username="${svn.username}" password="${svn.password}">
			<commit message="Committed on ${build-date} by JBossIDE Releng">
				<fileset dir="${work-dir}" includes="**/*"/>
			</commit>
		</svn>
		<delete dir="${work-dir}"/>
	</target>
</project>