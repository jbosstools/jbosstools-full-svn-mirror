<project name="Build specific targets and properties" default="noDefault" >

	<taskdef classpath="../lib/ant-contrib.jar" resource="net/sf/antcontrib/antlib.xml"/>
	
	<property file="custom.properties" />
	<!--property name="archiveName" value="jbpm-gpd-3.0-${buildId}.zip" /-->
	<property name="site-dir" value="${workspace-dir}/site" />
	<property name="site-stage-dir" value="${site-dir}/temp" />
	<property name="docbook-dir" value="${build-dir}/plugins/docbook-support" />
	<property name="docbook-download-dir" value="${download-dir}/docbook-support" />
	<property name="jbpm-core-dir" value="${build-dir}/plugins/${jbpm-core-module}.${jbpm-core-version-tag}" />
	<property name="jbpm-core-download-dir" value="${download-dir}/${jbpm-core-module}.${jbpm-core-version-tag}" />
	<property name="jbpm-core-plugin-dir" value="${build-dir}/plugins/org.jbpm.core" />
	<property name="jbpm-db-dir" value="${build-dir}/plugins/${jbpm-db-module}.${jbpm-db-version-tag}" />
	<property name="jbpm-db-download-dir" value="${download-dir}/${jbpm-db-module}.${jbpm-db-version-tag}" />
	<property name="jbpm-db-plugin-dir" value="${build-dir}/plugins/org.jbpm.db" />
	
	<import file="../common/bundlePlugins.xml"/>
<!-- ===================================================================== -->
<!-- Run a given ${target} on all elements being built -->
<!-- Add on <ant> task for each top level element being built. -->
<!-- ===================================================================== -->
<target name="allElements">
	 <ant antfile="${genericTargets}" target="${target}" >
		<property name="type" value="feature" />
		<property name="id" value="org.jbpm.feature" /> 
	</ant>
</target>

<!-- ===================================================================== -->
<!-- Targets to assemble the built elements for particular configurations  -->
<!-- These generally call the generated assemble scripts (named in -->
<!-- ${assembleScriptName}) but may also add pre and post processing -->
<!-- Add one target for each root element and each configuration -->
<!-- ===================================================================== -->

<target name="assemble.org.jbpm.feature">
	<property name="archiveName" value="jBPM-Designer-${versionTag}.zip"/>
	<ant antfile="${assembleScriptName}" dir="${buildDirectory}"/>
</target>

<!-- ===================================================================== -->
<!-- Check out map files from correct repository -->
<!-- Replace values for cvsRoot, package and mapVersionTag as desired. -->
<!-- ===================================================================== -->
<target name="getMapFiles">
	<property name="mapDir" value="${buildDirectory}/maps" />
	<cvs
		cvsRoot="${jbpm-cvs-root}"
		dest="${buildDirectory}"
		package="jbpm.ide/org.jbpm.build/maps"
		tag="HEAD"
	/>
	
	<copy todir="${mapDir}">
		<fileset file="${buildDirectory}/jbpm.ide/org.jbpm.build/maps/elements.map"/>
	</copy>
	
	<replace dir="${mapDir}" token="%jbpm-cvs-root%" value="${jbpm-cvs-root}" />
</target>

<!-- ===================================================================== -->
<!-- Steps to do before setup -->
<!-- ===================================================================== -->
<target name="preSetup">
	<echo message="doing preSetup"/>
</target>

<!-- ===================================================================== -->
<!-- Steps to do after setup but before starting the build proper -->
<!-- ===================================================================== -->
<target name="postSetup">
	<echo message="doing postSetup"/>
</target>

<!-- ===================================================================== -->
<!-- Steps to do before fetching the build elements -->
<!-- ===================================================================== -->
<target name="preFetch" depends="stage-docbook">
	<echo message="doing preFetch"/>
	<mkdir dir="${site-stage-dir}" />
	<cvs 
		cvsRoot="${jbpm-cvs-root}"
		package="jbpm.ide/org.jbpm.site"
		dest="${site-stage-dir}"
		tag="HEAD" />
	<copy todir="${site-stage-dir}">
		<fileset dir="${site-stage-dir}/jbpm.ide/org.jbpm.site">
			<include name="readme.txt"/>
			<include name="site.xml"/>
		</fileset>
	</copy>
	<delete dir="${site-stage-dir}/jbpm.ide" />
</target>

<target name="fetch-docbook-support">
	<cvs
		cvsRoot="${jboss-cvs-root}"
		package="docbook-support"
		dest="${download-dir}"
		tag="HEAD"/>
</target>
	
<target name="stage-docbook" depends="fetch-docbook-support">
	<mkdir dir="${docbook-dir}"/>
	<copy todir="${docbook-dir}">
		<fileset dir="${docbook-download-dir}" />
	</copy>
</target>
	
<!-- ===================================================================== -->
<!-- Steps to do after fetching the build elements -->
<!-- ===================================================================== -->
<target name="postFetch" depends="buildJbpmCoreFiles,buildJbpmDatabaseFiles">
	<property name="jbpm-help-dir" value="${build-dir}/plugins/org.jbpm.help" />
	<ant antfile="${jbpm-help-dir}/build/build.xml" dir="${jbpm-help-dir}" /> 
	<replace 
		file="${build-dir}/plugins/org.jbpm.ui/src/org/jbpm/ui/PluginConstants.java" 
		token="%default-jbpm-name%" value="${default-jbpm-name}" />
</target>

<target name="initPostFetch" >
</target>

<target name="getJbpmCore">
	<cvs
		cvsRoot="${jbpm-cvs-root}"
		package="${jbpm-core-module}"
		dest="${jbpm-core-download-dir}"
		tag="${jbpm-core-version-tag}"
		/>
</target>
	
<target name="getJbpmDB">
	<cvs
		cvsRoot="${jbpm-cvs-root}"
		package="${jbpm-db-module}"
		dest="${jbpm-db-download-dir}"
		tag="${jbpm-db-version-tag}"
		/>
</target>
	
<target name="buildJbpmCoreFiles" depends="getJbpmCore">
	<copy todir="${jbpm-core-dir}">
		<fileset dir="${jbpm-core-download-dir}/${jbpm-core-module}" />
	</copy>
	<ant antfile="build.xml" dir="${jbpm-core-dir}" />
	<copy todir="${jbpm-core-plugin-dir}" includeEmptyDirs="false" >
		<fileset dir="${jbpm-core-dir}" >
			<exclude name="build/**/*.*" />
			<exclude name=".*" />
			<exclude name="build.*" />
		</fileset>
	</copy>	
	<copy todir="${jbpm-core-plugin-dir}/lib/jbpm">
		<fileset dir="${jbpm-core-dir}/build" >
			<include name="*.jar" />
		</fileset>
	</copy>
</target>
	
<target name="buildJbpmDatabaseFiles" depends="getJbpmDB">
	<copy todir="${jbpm-db-plugin-dir}" includeEmptyDirs="false" >
		<fileset dir="${jbpm-db-download-dir}" >
			<exclude name="build.*" />
		</fileset>
	</copy>	
</target>
	
<!-- ===================================================================== -->
<!-- Steps to do before generating the build scripts. -->
<!-- ===================================================================== -->
<target name="preGenerate">
	<echo message="doing preGenerate"/>
</target>

<!-- ===================================================================== -->
<!-- Steps to do after generating the build scripts. -->
<!-- ===================================================================== -->
<target name="postGenerate">
	<echo message="doing postGenerate"/>
</target>


<!-- ===================================================================== -->
<!-- Steps to do before running the build.xmls for the elements being built. -->
<!-- ===================================================================== -->
<target name="preProcess">
	<echo message="doing preProcess"/>
</target>

<!-- ===================================================================== -->
<!-- Steps to do after running the build.xmls for the elements being built. -->
<!-- ===================================================================== -->
<target name="postProcess">
	<echo message="doing postProcess"/>
</target>


<!-- ===================================================================== -->
<!-- Steps to do before running assemble. -->
<!-- ===================================================================== -->
<target name="preAssemble">
	<echo message="doing preAssemble"/>
</target>

<!-- ===================================================================== -->
<!-- Steps to do after  running assemble. -->
<!-- ===================================================================== -->
<target name="postAssemble">
	<echo message="doing postAssemble"/>
	
	<bundlePlugins pluginList="${include.plugins}" buildDirectory="${buildDirectory}"
			archivePath="${buildDirectory}/${buildLabel}/jBPM-Designer-${versionTag}.zip" />
	
</target>

<!-- ===================================================================== -->
<!-- Steps to do after the build is done. -->
<!-- ===================================================================== -->
<target name="postBuild">
	<!--echo message="doing postBuild"/>
	<delete file="${site-stage-dir}/.project" />
	<delete dir="${site-stage-dir}/plugins" />
	<delete dir="${site-stage-dir}/features" />
	<property name="archive-file" value="${workspace-dir}/${buildLabel}/jBPM-Designer-${versionTag}.zip" />
	<unzip src="${archive-file}" dest="${site-stage-dir}" />
	<copy todir="${site-stage-dir}">
		<fileset dir="${site-stage-dir}/eclipse" />
	</copy>
	<delete dir="${site-stage-dir}/eclipse" />
	<foreach target="zipPluginDir" param="jarName" inheritAll="true" >
		<path>
			<dirset dir="${site-stage-dir}">
				<include name="plugins/*" />
				<include name="features/*" />
			</dirset>
		</path>
	</foreach>
	<zip destfile="${site-dir}/${archiveName}" basedir="${site-stage-dir}" />
	<delete dir="${site-stage-dir}" /-->
</target>

<target name="zipPluginDir">
	<zip destfile="${jarName}.jar" basedir="${jarName}" />
	<delete dir="${jarName}" />
</target>

<!-- ===================================================================== -->
<!-- Steps to do to test the build results -->
<!-- ===================================================================== -->
<target name="test">
	<echo message="doing test"/>
</target>

<!-- ===================================================================== -->
<!-- Steps to do to publish the build results -->
<!-- ===================================================================== -->
<target name="publish">
	<echo message="doing publish"/>
</target>

<!-- ===================================================================== -->
<!-- Default target                                                        -->
<!-- ===================================================================== -->
<target name="noDefault">
	<echo message="You must specify a target when invoking this file" />
</target>

</project>
