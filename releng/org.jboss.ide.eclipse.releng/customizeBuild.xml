<project default="customize.interactive">

	<taskdef classpath="lib/ant-contrib.jar" resource="net/sf/antcontrib/antlib.xml"/>
	
	<taskdef name="antform" classname="com.sardak.antform.AntForm" 
	            classpath="lib/antform.jar"/>
	<taskdef name="antmenu" classname="com.sardak.antform.AntMenu" 
	            classpath="lib/antform.jar"/>
	
	<target name="customize">
		<property file="customize.properties"/>
		
		<if>
			<equals arg1="${enable.publishing}" arg2="false"/>
			<then>
				<property name="comment.enable.publishing" value="#"/>
			</then>
			<else>
				<property name="comment.enable.publishing" value=""/>
			</else>
		</if>
		
		<if>
			<equals arg1="${enable.notification}" arg2="false"/>
			<then>
				<property name="comment.enable.notification" value="#"/>
			</then>
			<else>
				<property name="comment.enable.notification" value=""/>
			</else>
		</if>
		
		<copy todir="builders" overwrite="true">
			<fileset dir="builders">
				<include name="**/*.properties.template"/>
			</fileset>
			<mapper type="glob" from="*.properties.template" to="*.properties"/>
			<filterset begintoken="%" endtoken="%">
				<filter token="eclipse-archive-path" value="${eclipse.archive.path}"/>
				<filter token="ssh-key" value="${ssh.key}"/>
				<filter token="ssh-passphrase" value="${ssh.passphrase}"/>
				<filter token="build-output-directory" value="${build.output.directory}"/>
				<filter token="clean-eclipse-home" value="${clean.eclipse.home}"/>
				<filter token="releng-root" value="${releng.root}"/>
				
				<filter token="comment-enable-publishing" value="${comment.enable.publishing}"/>
				<filter token="enable-publishing" value="${enable.publishing}"/>
				<filter token="comment-enable-notification" value="${comment.enable.notification}"/>
				<filter token="enable-notification" value="${enable.notification}"/>
				<filter token="build-script-ext" value="${build.script.ext}"/>
			</filterset>
		</copy>
		
		<mkdir dir="bin"/>
		<javac destdir="bin" srcdir="src">
			<classpath>
				<fileset dir="lib">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</javac>
		
		<!-- this will copy all property and xml files over to the bin folder -->
		<copy todir="bin">
			<fileset dir="src">
				<exclude name="**/*.java"/>
			</fileset>
		</copy>
	</target>
	
	<target name="customize.interactive">
		<if>
			<available file="customize.properties"/>
			<then>
				<property file="customize.properties"/>
			</then>
		</if>
			
		<property name="releng.root" value="${basedir}"/>
		<property name="enable.publishing" value="false"/>
		<property name="enable.notification" value="false"/>
		<condition property="build.script.ext" value="sh" else="bat" >
			<os family="unix"/>
		</condition>
		
		<antform title="JBossIDE Build System Setup" 
			save="customize.properties"
			stylesheet="customize.style"
			image="art/jbosside-logo.png"
			nexttarget="ssh.customization">
			
			<radioselectionproperty label="Build script type" values="sh,bat" property="build.script.ext" />
			
			<fileselectionproperty label="Location of Eclipse binaries"
				property="eclipse.archive.path"
				required="true" directorychooser="true" editable="true"/>

			<fileselectionproperty label="Location for build binaries"
				property="build.output.directory"
				required="true" directorychooser="true" editable="true"/>
			
			<fileselectionproperty label="Location of a clean eclipse 3.1.1 installation (no external plugins)"
				property="clean.eclipse.home"
				required="true" directorychooser="true" editable="true"/>
			
			<fileselectionproperty label="Location of JBossIDE Releng Project Root"
				property="releng.root"
				required="true" directorychooser="true" editable="true"/>
			
			<separator/>
			
			<booleanProperty label="Enable SCP Publishing" property="enable.publishing"/>
			
			<booleanProperty label="Enable Email Notification" property="enable.notification"/>
		</antform>
	</target>
	
	<target name="ssh.customization">
		<if>
			<equals arg1="${enable.publishing}" arg2="true"/>
			<then>
				<antform title="SSH Configuration" 
					save="customize.properties"
					stylesheet="customize.style"
					image="art/jbosside-logo.png">
		
					<fileselectionproperty label="Location of SSH Private Key"
						property="ssh.key" required="false" editable="true" if="enable.publishing"/>
					<textproperty password="true" label="SSH Passphrase" property="ssh.passphrase" if="enable.publishing" />
					
				</antform>
			</then>
			<else>
				<echo file="customize.properties">
ssh.key=
ssh.passphrase=
				</echo>
			</else>
		</if>

		<antcall target="customize"/>
	</target>
	
</project>