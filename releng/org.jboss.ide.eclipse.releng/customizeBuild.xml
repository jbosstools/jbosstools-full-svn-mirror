<project default="customize.interactive">

	<taskdef classpath="lib/ant-contrib.jar" resource="net/sf/antcontrib/antlib.xml"/>
	
	<taskdef name="antform" classname="com.sardak.antform.AntForm" 
	            classpath="lib/antform.jar"/>
	<taskdef name="antmenu" classname="com.sardak.antform.AntMenu" 
	            classpath="lib/antform.jar"/>
	
	<macrodef name="convertpath">
		<attribute name="path"/>
		<attribute name="property"/>
		<sequential>
			<pathconvert property="@{property}" dirsep="/">
				<path><pathelement path="@{path}"/></path>
			</pathconvert>
		</sequential>
	</macrodef>
	
	<target name="customize">
		<property file="customize.properties"/>
		
		<!-- fix referential bug -->
		<property name="ssh.key" value=""/>
		<property name="ssh.passphrase" value=""/>
		<property name="svn.username" value=""/>
		<property name="svn.password" value=""/>
		<property name="enable.downloads.update" value="false"/>
		
		<if>
			<equals arg1="${enable.publishing}" arg2="false"/>
			<then>
				<property name="comment.enable.publishing" value="#"/>
			</then>
			<else>
				<property name="comment.enable.publishing" value=""/>
			</else>
		</if>
		
		<if>
			<equals arg1="${enable.notification}" arg2="false"/>
			<then>
				<property name="comment.enable.notification" value="#"/>
			</then>
			<else>
				<property name="comment.enable.notification" value=""/>
			</else>
		</if>
		
		<if>
			<equals arg1="${enable.downloads.update}" arg2="false"/>
			<then>
				<property name="comment.enable.downloads.update" value="#"/>
			</then>
			<else>
				<property name="comment.enable.downloads.update" value=""/>
			</else>
		</if>
		
		<!-- force unix like paths.. the windows escaping mess is unmanageable -->
		<convertpath path="${eclipse.archive.path}" property="eclipse.archive.path.escaped"/>
		<convertpath path="${ssh.key}" property="ssh.key.escaped"/>
		<convertpath path="${build.output.directory}" property="build.output.directory.escaped"/>
		<convertpath path="${clean.eclipse.home}" property="clean.eclipse.home.escaped"/>
		<convertpath path="${releng.root}" property="releng.root.escaped"/>
		
		<copy todir="builders" overwrite="true">
			<fileset dir="builders">
				<include name="**/*.properties.template"/>
			</fileset>
			<mapper type="glob" from="*.properties.template" to="*.properties"/>
			<filterset begintoken="%" endtoken="%">
				<filter token="eclipse-archive-path" value="${eclipse.archive.path.escaped}"/>
				<filter token="ssh-key" value="${ssh.key.escaped}"/>
				<filter token="ssh-passphrase" value="${ssh.passphrase}"/>
				<filter token="build-output-directory" value="${build.output.directory.escaped}"/>
				<filter token="clean-eclipse-home" value="${clean.eclipse.home.escaped}"/>
				<filter token="releng-root" value="${releng.root.escaped}"/>
				
				<filter token="comment-enable-publishing" value="${comment.enable.publishing}"/>
				<filter token="enable-publishing" value="${enable.publishing}"/>
				<filter token="comment-enable-notification" value="${comment.enable.notification}"/>
				<filter token="enable-notification" value="${enable.notification}"/>
				
				<filter token="comment-enable-downloads-update" value="${comment.enable.downloads.update}"/>
				<filter token="enable-downloads-update" value="${enable.downloads.update}"/>
				<filter token="svn-username" value="${svn.username}"/>
				<filter token="svn-password" value="${svn.password}"/>
				
				<filter token="build-script-ext" value="${build.script.ext}"/>
			</filterset>
		</copy>
		
		<mkdir dir="bin"/>
		<javac destdir="bin" srcdir="src">
			<classpath>
				<fileset dir="lib">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</javac>
		
		<!-- this will copy all property and xml files over to the bin folder -->
		<copy todir="bin">
			<fileset dir="src">
				<exclude name="**/*.java"/>
			</fileset>
		</copy>
	</target>
	
	<target name="customize.interactive">
		<if>
			<available file="customize.properties"/>
			<then>
				<property file="customize.properties"/>
			</then>
		</if>
			
		<property name="releng.root" value="${basedir}"/>
		<property name="enable.publishing" value="false"/>
		<property name="enable.notification" value="false"/>
		<condition property="build.script.ext" value="sh" else="bat" >
			<os family="unix"/>
		</condition>
		
		<antform title="JBossIDE Build System Setup" 
			save="customize.properties"
			stylesheet="customize.style"
			image="art/jbosside-logo.png"
			nexttarget="ssh.customization">
			
			<radioselectionproperty label="Build script type" values="sh,bat" property="build.script.ext" />
			
			<fileselectionproperty label="Location of Eclipse binaries"
				property="eclipse.archive.path"
				required="true" directorychooser="true" editable="true"/>

			<fileselectionproperty label="Location for build binaries"
				property="build.output.directory"
				required="true" directorychooser="true" editable="true"/>
			
			<fileselectionproperty label="Location of a clean eclipse 3.1.1 installation (no external plugins)"
				property="clean.eclipse.home"
				required="true" directorychooser="true" editable="true"/>
			
			<fileselectionproperty label="Location of JBossIDE Releng Project Root"
				property="releng.root"
				required="true" directorychooser="true" editable="true"/>
			
			<separator/>
			
			<booleanProperty label="Enable SCP Publishing" property="enable.publishing"/>
			
			<booleanProperty label="Enable Email Notification" property="enable.notification"/>
			
			<booleanProperty label="Enable Downloads Page Update" property="enable.downloads.update"/>
		</antform>
	</target>
	
	<target name="ssh.customization">
		<if>
			<equals arg1="${enable.publishing}" arg2="true"/>
			<then>
				<antform title="SSH Configuration" 
					save="customize.properties"
					stylesheet="customize.style"
					image="art/jbosside-logo.png"
					nexttarget="downloads.customization">
		
					<fileselectionproperty label="Location of SSH Private Key"
						property="ssh.key" required="false" editable="true" if="enable.publishing"/>
					<textproperty password="true" label="SSH Passphrase" property="ssh.passphrase" if="enable.publishing" />
					
				</antform>
			</then>
			<else>
				<antcall target="downloads.customization" inheritall="true"/>
			</else>
		</if>
	</target>
	
	<target name="downloads.customization">
		<if>
			<equals arg1="${enable.downloads.update}" arg2="true"/>
			<then>
				<antform title="Labs Downloads Page Configuration" 
					save="customize.properties"
					stylesheet="customize.style"
					image="art/jbosside-logo.png">
		
					<textproperty label="JBossLabs/SVN Username" property="svn.username" if="enable.downloads.update" />
					<textproperty password="true" label="JBossLabs/SVN Password" property="svn.password" if="enable.downloads.update" />
					
				</antform>
			</then>
		</if>
		
		<antcall target="customize" inheritall="true"/>
	</target>
</project>