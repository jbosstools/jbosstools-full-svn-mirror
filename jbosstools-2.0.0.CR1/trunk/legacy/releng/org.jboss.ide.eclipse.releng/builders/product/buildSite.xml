<project>
	
	<property file="..//global.properties"/>
	<property file="build.properties"/>

	<import file="../common/scp.xml" />
	<import file="../common/common.xml" />
	
	<target name="development">
		<property name="update.site.type" value="development"/>
		<antcall target="publish.site" inheritall="true"/>
	</target>
	
	<target name="stable">
		<property name="update.site.type" value="stable"/>
		<antcall target="publish.site" inheritall="true"/>
	</target>
	
	<target name="load.properties">
		<get.version.tag builder="aop" property="aop.versionTag"/>
		<get.version.tag builder="ejb3" property="ejb3.versionTag"/>
		<get.version.tag builder="core" property="core.versionTag"/>
		<load.property file="../hibernate-tools/build.properties" property="hibernate.tools.release"/>
		<get.version.tag builder="hibernate-tools" property="hibernate-tools.versionTag"/>
		<get.version.tag builder="jbpm" property="jbpm.versionTag"/>
		<get.version.tag builder="as" property="as.versionTag"/>
		<get.version.tag builder="freemarker" property="freemarker.versionTag"/>
		<get.version.tag builder="cache" property="cache.versionTag"/>
		<get.version.tag builder="drools-ide" property="drools-ide.versionTag"/>
		<get.version.tag builder="jbossws" property="jbossws.versionTag"/>
	</target>
	
	<target name="build.site">
		<mkdir dir="${product.build.root}/site"/>
		
		<unzip
			src="${product.build.root}/${product.versionTag}/all/${product.name}-${product.versionTag}-ALL.zip"
			dest="${product.build.root}/site"/>
		
		<for param="directory">
			<path>
				<dirset dir="${product.build.root}/site/eclipse">
					<include name="*/*"/>
				</dirset>
			</path>
			<sequential>
				<if>
					<available file="@{directory}/META-INF/MANIFEST.MF"/>
					<then>
						<!-- we don't want to override the MANIFEST -->
						<jar destfile="@{directory}.jar"  manifest="@{directory}/META-INF/MANIFEST.MF">
							<fileset dir="@{directory}">
								<include name="**/*"/>
							</fileset>
						</jar>
					</then>
					<else>
						<jar destfile="@{directory}.jar">
							<fileset dir="@{directory}">
								<include name="**/*"/>
							</fileset>
						</jar>
					</else>
				</if>
				<delete includeemptydirs="true" failonerror="false">
					<fileset dir="@{directory}" defaultexcludes="false"/>
				</delete>
			</sequential>
		</for>
	</target>
	
	<target name="build.metadata" depends="build.site,load.properties">
		<copy todir="${product.build.root}/site/eclipse" overwrite="true">
			<fileset dir="updateSite/${update.site.type}">
				<include name="**/*.template"/>
			</fileset>
			<mapper type="glob" from="*.template" to="*"/>
			<filterset begintoken="%" endtoken="%">
				<filter token="jbpm-feature-version" value="${jbpm.versionTag}"/>
				<filter token="jbpm-feature-jar" value="org.jbpm.feature_${jbpm.versionTag}.jar"/>
				<filter token="aop-feature-version" value="${aop.versionTag}"/>
				<filter token="aop-feature-jar" value="org.jboss.ide.eclipse.jdt.aop.feature_${aop.versionTag}.jar"/>
				<filter token="core-feature-version" value="${core.versionTag}"/>
				<filter token="core-feature-jar" value="org.jboss.ide.eclipse.feature_${core.versionTag}.jar"/>
				<filter token="hibernate-tools-feature-version" value="${hibernate.tools.release}.${hibernate-tools.versionTag}"/>
				<filter token="hibernate-tools-feature-jar" value="org.hibernate.eclipse.feature_${hibernate.tools.release}.${hibernate-tools.versionTag}.jar"/>
				<filter token="ejb3-feature-version" value="${ejb3.versionTag}"/>
				<filter token="ejb3-feature-jar" value="org.jboss.ide.eclipse.ejb3.feature_${ejb3.versionTag}.jar"/>
				<filter token="as-feature-version" value="${as.versionTag}"/>
				<filter token="as-feature-jar" value="org.jboss.ide.eclipse.as.feature_${as.versionTag}.jar"/>
				<filter token="freemarker-feature-version" value="${freemarker.versionTag}"/>
				<filter token="freemarker-feature-jar" value="org.jboss.ide.eclipse.freemarker.feature_${freemarker.versionTag}.jar"/>
				<filter token="cache-feature-version" value="${cache.versionTag}"/>
				<filter token="cache-feature-jar" value="org.jboss.ide.eclipse.jbosscache.feature_${cache.versionTag}.jar"/>
				<filter token="drools-ide-feature-version" value="${drools-ide.versionTag}"/>
				<filter token="drools-ide-feature-jar" value="org.drools.ide.feature_${drools-ide.versionTag}.jar"/>
				<filter token="jbossws-feature-jar" value="com.eviware.soapui.jbosside_feature_${jbossws.versionTag}.jar"/>
				<filter token="jbossws-feature-version" value="${jbossws.versionTag}"/>
				<filter token="jbosside-build-name" value="${product.versionTag}"/>
			</filterset>
		</copy>
	</target>
	
	<target name="publish.site" depends="build.metadata" unless="noPublish">
		<scp.fileset.trusted relative="false" todir="/htdocs/jbosside/updates/${update.site.type}">
			<fileset dir="${product.build.root}/site/eclipse">
				<include name="**/*"/>
			</fileset>
		</scp.fileset.trusted>
	</target>
</project>
