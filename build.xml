<!-- Run a given ${COMPONENT} build -->
<project default="run" basedir=".">

	<!-- Configuration Start -->
	<!-- must set name of component to build/test -->
	<property name="COMPONENT" value="tests" />

	<!-- default maven version --> 
	<property name="maven.version" value="3.0-alpha-7" />
	<!-- Configuration Ends -->

	<!-- To run this script in Eclipse:
			Run As > Ant Build
	-->
	<!-- To run this script via commandline (build default module, tests):
			cd /home/nboldt/workspace36/jbosstools-modular_build; ant
		 or, to build a specific module: 
			cd /home/nboldt/workspace36/jbosstools-modular_build; ant -DCOMPONENT=jbpm 
	-->

	<target name="run" depends="init, genpom, install, deploy" />

	<!-- override for local build -->
	<condition property="isInHudson" value="true">
		<or>
			<contains string="${user.dir}" substring="hudson" />
			<contains string="${user.name}" substring="hudson" />
			<contains string="${user.home}" substring="hudson" />
		</or>
	</condition>
	<target name="local" unless="isInHudson">
		<property name="WORKINGDIR" value="${basedir}" />
		<property name="COMMON_TOOLS" value="${java.io.tmpdir}" />
	</target>

	<target name="get.ant-contrib" unless="ant-contrib.jar.exists">
		<property name="ANTCONTRIB_MIRROR" value="http://downloads.sourceforge.net/ant-contrib/" />
		<get usetimestamp="true"
		     dest="${COMMON_TOOLS}/ant-contrib-1.0b2-bin.zip"
		     src="${ANTCONTRIB_MIRROR}/ant-contrib-1.0b2-bin.zip"
		/>
		<touch file="${COMMON_TOOLS}/ant-contrib-1.0b2-bin.zip" />
		<mkdir dir="${java.io.tmpdir}/ant-contrib-1.0b2-bin.zip_" />
		<unzip src="${COMMON_TOOLS}/ant-contrib-1.0b2-bin.zip"
		       dest="${java.io.tmpdir}/ant-contrib-1.0b2-bin.zip_"
		       overwrite="true"
		/>
		<copy file="${java.io.tmpdir}/ant-contrib-1.0b2-bin.zip_/ant-contrib/lib/ant-contrib.jar"
		      tofile="${COMMON_TOOLS}/ant-contrib.jar"
		      failonerror="true"
		/>
		<delete dir="${java.io.tmpdir}/ant-contrib-1.0b2-bin.zip_" includeemptydirs="true" quiet="true" />
	</target>

	<target name="init" depends="local">
		<property name="WORKINGDIR" value="${basedir}" />
		<property name="COMMON_TOOLS" value="${WORKINGDIR}/../tools" />
		<mkdir dir="${COMMON_TOOLS}" />

		<available file="${COMMON_TOOLS}/ant-contrib.jar" type="file" property="ant-contrib.jar.exists" />
		<antcall target="get.ant-contrib" />
		<taskdef resource="net/sf/antcontrib/antlib.xml">
			<classpath>
				<pathelement location="${COMMON_TOOLS}/ant-contrib.jar" />
			</classpath>
		</taskdef>

		<property name="MAVEN_MIRROR" value="http://mirror.csclub.uwaterloo.ca/apache/maven/binaries" />
		<get usetimestamp="true"
		     dest="${COMMON_TOOLS}/apache-maven-${maven.version}-bin.tar.gz"
		     src="${MAVEN_MIRROR}/apache-maven-${maven.version}-bin.tar.gz"
		/>
		<untar compression="gzip"
		       overwrite="false"
		       dest="${COMMON_TOOLS}"
		       src="${COMMON_TOOLS}/apache-maven-${maven.version}-bin.tar.gz"
		/>
		<chmod perm="755" file="${COMMON_TOOLS}/apache-maven-${maven.version}/bin/mvn" />
	</target>

	<target name="genpom">
		<ant antfile="genpom.xml" target="run">
			<property name="WORKINGDIR" value="${WORKINGDIR}/${COMPONENT}" />
			<property name="pathToParentPom" value="../" />
		</ant>
	</target>

	<target name="install">
		<!-- <echo level="debug">Generate settings.xml file</echo>
		<mkdir dir="${COMMON_TOOLS}/m2-repository" />
		<echo file="${COMMON_TOOLS}/apache-maven-${maven.version}/conf/settings.xml">
&lt;settings xmlns="http://maven.apache.org/settings/1.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd">
  &lt;localRepository>${COMMON_TOOLS}/m2-repository&lt;/localRepository>
  &lt;interactiveMode>false&lt;/interactiveMode>
  &lt;pluginGroups>&lt;/pluginGroups>&lt;proxies>&lt;/proxies>&lt;servers>&lt;/servers>&lt;mirrors>&lt;/mirrors>&lt;profiles>&lt;/profiles>
&lt;/settings></echo> -->

		<echo level="verbose">Exe: ${COMMON_TOOLS}/apache-maven-${maven.version}/bin/mvn</echo>
		<echo level="verbose">Pom: ${WORKINGDIR}/${COMPONENT}/pom.xml</echo>
		<exec executable="${COMMON_TOOLS}/apache-maven-${maven.version}/bin/mvn"
		      dir="${WORKINGDIR}/${COMPONENT}"
		      failifexecutionfails="true"
		      failonerror="true"
		      timeout="10800000"
		>
			<env key="M2_HOME" value="${COMMON_TOOLS}/apache-maven-${maven.version}" />
			<!-- <env key="MAVEN_OPTS"
			     value="-Xdebug -Xnoagent -Djava.compiler=NONE -Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=8000"
			/> -->
			<!-- <arg line="-gs ${COMMON_TOOLS}/apache-maven-${maven.version}/conf/settings.xml" /> -->
			<!-- <arg line="-o -Dmaven.test.skip" /> -->
			<arg line="-fae clean install" />
		</exec>
	</target>

	<target name="deploy">
		<!-- TODO enable publishing to download.jboss.org or porkchop.jboss.com
		<get usetimestamp="true"
		     dest="${COMMON_TOOLS}/maven-ant-tasks-2.1.0.jar"
		     src="${MAVEN_MIRROR}/maven-ant-tasks-2.1.0.jar"
		/>
		<taskdef resource="org/apache/maven/artifact/ant/antlib.xml">
			<classpath>
				<pathelement location="${COMMON_TOOLS}/maven-ant-tasks-2.1.0.jar" />
			</classpath>
		</taskdef>
		<install-provider artifactId="wagon-ssh" version="1.0-beta-2"/>
		<deploy file="target/my-project-1.0.jar">
			<remoteRepository url="scp://localhost/www/repository">
				<authentication username="${repository.username}" privateKey="${user.home}/.ssh/id_dsa" />
			</remoteRepository>
			<pom refid="mypom" />
		</deploy>
		-->
	</target>
</project>

