<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Chapter&nbsp;5.&nbsp;Getting Started Guide for JSF with Hibernate</title><link rel="stylesheet" href="css/html.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.65.1"><link rel="home" href="index.html" title="Getting Started with Red Hat Developer Studio"><link rel="up" href="index.html" title="Getting Started with Red Hat Developer Studio"><link rel="previous" href="GettingStartedStrutsValidationExamples.html" title="Chapter&nbsp;4.&nbsp;Getting Started Struts Validation Examples"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Chapter&nbsp;5.&nbsp;Getting Started Guide for JSF with Hibernate</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="GettingStartedStrutsValidationExamples.html">Prev</a>&nbsp;</td><th width="60%" align="center">&nbsp;</th><td width="20%" align="right">&nbsp;</td></tr></table><hr></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="GettingStartedGuideforJSFwithHibernate"></a>Chapter&nbsp;5.&nbsp;Getting Started Guide for JSF with Hibernate</h2></div></div><div></div></div><p>In this guide, we will show you how to take a very simple ready-made JSF application and convert it to use a database with the help of Exadel Studio. After downloading, we will first</p><p>set up and run the application without persistence, and then with persistence.</p><p>The application itself is a simple JSF-based application that asks the user to enter a UserID. It tries to locate a record for the entered User ID (entered during the application session).</p><p>If the record is found, details are displayed. If the record is not found, you are asked to create this record. This application, of course, only runs as long as the Tomcat server is running. Once we stop the server all of the data is lost as all information is saved only in the application session context.</p><p>With the help of Exadel Studio, we will convert this application to use the lightweight hsqldb database (included with the downloaded project). We will use Exadel Studio special features for object-relational mapping for this conversion After the conversion, even if we restart the server, the data we entered will have been saved in a database and thus available to the application.</p><p>Before we start, we assume that you have Eclipse, and have installed Exadel Studio Pro with Tomcat server.</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="InstallingTheProject"></a>5.1.&nbsp;Installing the Project</h2></div></div><div></div></div><p>We are first going to download and import this project (ormHibernate3-jsf) into Eclipse.</p><div class="orderedlist"><ol type="1"><li><p>Download: http://webdownload.exadel.com/dirdownloads/ormhib/examples/ormHibernate3-jsf.zip</p></li><li><p>Unzip this file into your Eclipse workspace folder.</p></li><li><p>Launch Eclipse.</p></li><li><p>In Eclipse, select File/Import/JSF Project.</p></li><li><p>Click Next.</p></li><li><p>Browse to where the project was unzipped.</p></li><li><p>Find the web.xml file inside the WebContent folder in the WEB-INF folder, select it, and Click Finish.</p></li></ol></div><p>The ormHibernate3-jsf project should appear in the Package Explorer with a standard Web application 
structure. As we mentioned before, this is a JSF application. To see the JSF configuration file, browse to
 WebContent/WEB-INF/faces-config.xml.</p><p>In the JavaSource folder, you will find the following Java source files. We will briefly explain these
 files and then run the application.</p><div class="table"><a name="d0e1374"></a><p class="title"><b>Table&nbsp;5.1.&nbsp;JavaSource Folder</b></p><table summary="JavaSource Folder" border="1"><colgroup><col><col></colgroup><thead><tr><th>Class Name</th><th>Description</th></tr></thead><tbody><tr><td>demo/Address.java</td><td>holds the user address</td></tr><tr><td>demo/User.java</td><td>holds user information</td></tr><tr><td>demo/GetUserIdBean.java</td><td>holds user Id and determines navigation (JSF Backing Bean)</td></tr><tr><td>demo/UserFormBean.java</td><td>holds new user input (JSF Backing Bean)</td></tr><tr><td>demo.bundle/Messages.properties</td><td>holds label messages used in the application</td></tr></tbody></table></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="RunningWithoutADatabase"></a>5.2.&nbsp;Running Without a Database</h2></div></div><div></div></div><p>We are ready to run this project in a Web browser and see how it looks. We don't need to
 compile these classes, because Eclipse did it for us when we imported the project.</p><div class="orderedlist"><ol start="8" type="1"><li><p>Start Tomcat.</p></li><li><p>Click on the running-man-and-blue-butterfly icon from the toolbar.</p></li><li><p>Go ahead and play with the application.</p></li></ol></div><p>Initially users don't exist, so entering any ID will prompt you to enter user details. Once you have saved a user, you can go back to the main page by clicking on the Back to Login Page link. If you then enter that user's id again, the application will locate and display the user's details.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ConvertingforUseWithaDatabase"></a>5.3.&nbsp;Converting for Use With a Database</h2></div></div><div></div></div><p>Now we are ready to convert this application to use with a database with the help of ExadelStudio. To convert the application for use with a database, we need to set things up in three different places:</p><div class="itemizedlist"><ul type="disc"><li><p>The Application</p></li></ul></div><div class="itemizedlist"><ul type="disc"><li><p>The Database</p></li></ul></div><div class="itemizedlist"><ul type="disc"><li><p>The Application Server</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="SettingUpTheApplication"></a>5.4.&nbsp;Setting up the Application</h2></div></div><div></div></div><p>Setting up the Application</p><p>Let's start by using Red Hat Developer Studio with the application project. First, we create 
the object/relational mapping from our simple object model to a database schema after adding Hibernate 
capabilities to our project.</p><div class="orderedlist"><ol start="11" type="1"><li><p>Right-click on ormHibernate3-jsf in the Package Explorer view and select Exadel</p></li><li><p>Studio/Add Hibernate Capability... from the context menu.</p></li><li><p>Click on Yes in the the dialog box with Add Hibernate Jars selected.</p></li><li><p>In the Configuration Wizard, click twice in the Value field for dialect and select org.hibernate.dialect.HSQLDialect from the pop-up menu.</p></li><li><p>Click Finish</p></li><li><p>Select Object to Schema for the Mapping Approach.</p></li></ol></div><p>We are only interested in saving the User class in a database, so we are going to create a mapping for the User class to a database table.</p><div class="orderedlist"><ol start="17" type="1"><li><p>In the Persistent Classes Wizard dialog that appears next, click on the SelectClasses.</p></li><li><p>Leave all other values as they are in the next dialog box and click Finish.</p></li></ol></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="EditTheHibernateConfiguration"></a>5.5.&nbsp;Edit the Hibernate Configuration</h2></div></div><div></div></div><p>Afterwards, the Hibernate configuration file, hibernate.cfg.xml, will appear in an editor window. 
So, let's adjust this file first.</p><div class="orderedlist"><ol start="19" type="1"><li><p>Replace these two lines:</p></li></ol></div><pre class="programlisting">&lt;property
name="hibernate.connection.driver_class"&gt;org.hsqldb.jdbcDriver&lt;/
property&gt;
&lt;property
name="hibernate.connection.url"&gt;jdbc:hsqldb:hsql:[hostname]&lt;/
property&gt;
</pre><p>With this single line:</p><pre class="programlisting">
&lt;property name="hibernate.connection.datasource"&gt;java:comp/env/
jdbc/kickstart&lt;/property&gt;
</pre><p>(Make sure this is one line in the file and not two lines as displayed because of wordwrapping.)</p><p>Your file should now look like this:</p><pre class="programlisting">
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE hibernate-configuration PUBLIC "-//Hibernate/Hibernate Configuration
DTD 3.0//EN" "http://hibernate.sourceforge.net/hibernate-configuration-3.0.dtd"&gt;
&lt;hibernate-configuration&gt;
&lt;session-factory&gt;
&lt;property name="hibernate.connection.datasource"&gt;java:comp/env/jdbc/
kickstart&lt;/property&gt;
Exadel Studio 3.0
page 4 of 10
&lt;property name="hibernate.dialect"&gt;org.hibernate.dialect.HSQLDialect&lt;/
property&gt;
&lt;mapping resource="demo/User.hbm.xml"/&gt;
&lt;/session-factory&gt;
&lt;/hibernate-configuration&gt;
</pre><div class="orderedlist"><ol start="20" type="1"><li><p>Save the file.</p></li></ol></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="EdittheMappingFile"></a>5.6.&nbsp;Edit the Mapping File</h2></div></div><div></div></div><p>Next, we need to make on slight change to the mapping file, User.hbm.xml.</p><div class="orderedlist"><ol start="21" type="1"><li><p>In the ORM Explorer view, reveal the 
ormHibernate3-jsf/JavaSource/hibernate.cfg.xml/demo/User -&gt; user node, right-click it, and select 
Open Mapping from the context menu.</p></li><li><p>In the editor that opens up for the mapping file, just change the class 
attribute for generator to a value of assigned and you're done with this file.</p></li></ol></div><p>Here is what the edited User.hbm.xml file should now look like:</p><pre class="programlisting">
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE hibernate-mapping PUBLIC "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
&lt;para&gt;"http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd"&gt;&lt;/para&gt;
&lt;hibernate-mapping package="demo"&gt;
&lt;class name="User" table="user" optimistic-lock="none"&gt;
&lt;id name="id" type="string" unsaved-value="null" column="id"&gt;
&lt;generator class="assigned"/&gt;
&lt;/id&gt;
&lt;property name="firstName" type="string" column="first_name"/&gt;
&lt;property name="lastName" type="string" column="last_name"/&gt;
&lt;property name="email" type="string" column="email"/&gt;
&lt;component name="address" update="true" insert="true" class="demo.Address"&gt;
&lt;property name="city" type="string" column="address_city"/&gt;
&lt;property name="state" type="string" column="address_state"/&gt;
&lt;property name="street" type="string" column="address_street"/&gt;
&lt;property name="zip" type="string" column="address_zip"/&gt;
&lt;/component&gt;
&lt;/class&gt;
&lt;/hibernate-mapping&gt;
</pre><div class="orderedlist"><ol start="23" type="1"><li><p>Save the file.</p></li></ol></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="AddAGeneralClassForIncorporatingHibernate"></a>5.7.&nbsp;Add a General Class for Incorporating Hibernate</h2></div></div><div></div></div><p>Next, we will need to create a special Java class for incorprating Hibernate into our application.</p><div class="orderedlist"><ol start="24" type="1"><li><p>Switch to the Package Explorer view and create the class,
HibernateHelper.java, in JavaSource/demo with this content and save it.</p></li></ol></div><pre class="programlisting">
package demo;
import org.hibernate.HibernateException;
import org.hibernate.Session;
import org.hibernate.SessionFactory;
import org.hibernate.cfg.Configuration;
public class HibernateHelper {
/**
* Reference to SessionFactory.
*/
private static SessionFactory sf;
public static final ThreadLocal session = new ThreadLocal();
public static synchronized void init() {
if (sf != null) return;
System.out.println("Initializing Hibernate");
try {
Configuration cfg = new Configuration().configure();
sf = cfg.buildSessionFactory();
} catch (Exception he) {
System.err.println("Unable to create session factory from
configuration");
he.printStackTrace();
throw new RuntimeException("Unable to create session factory from
configuration", he);
}
System.out.println("Hibernate initialized");
}
/**
* Return the SessionFactory.
* @return The SessionFactory for this application session
*/
public static SessionFactory sessionFactory() {
if (sf == null) init();
return sf;
}
public static void destroy() {
if (sf != null) {
try {
sf.close();
} catch (HibernateException he) {
he.printStackTrace();
}
}
sf = null;
System.out.println("Hibernate resources released");
}
/**
* Closes an hibernate {@link Session}, releasing its resources.
* @throws HibernateException if an hibernate error occurs
*/
public static void closeSession() throws HibernateException {
Session s = (Session)session.get();
session.set(null);
if (s != null) {
s.close();
Exadel Studio Pro
page 6 of 9
}
}
/**
* Returns an hibernate {@link Session} from the session factory.
* @return an hibernate {@link Session}
* @throws HibernateException if an error occurs
*/
public static Session openSession() throws HibernateException {
if (sf == null) init();
Session s = (Session)session.get();
if (s == null) {
s = sf.openSession();
session.set(s);
}
return (s);
}
}
</pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="EdittheTwoBeanClasses"></a>5.8.&nbsp;Edit the Two Bean Classes</h2></div></div><div></div></div><p>We also need to modify the two bean classes in our application to "Hibernate-ize" them.</p><div class="orderedlist"><ol start="25" type="1"><li><p>Modify the GetUserIdBean.java class in JavaSource/demo by adding these imports:

</p></li></ol></div><pre class="programlisting">import org.hibernate.Session;
import javax.faces.application.FacesMessage;
</pre><div class="orderedlist"><ol start="26" type="1"><li><p>Then, replace the action() method with this code and save.</p></li></ol></div><pre class="programlisting">{
public String action()
throws Exception
UserFormBean ufb;
User user;
String actionResult = "inputuser"; // new user by default
Map sessionMap =
FacesContext.getCurrentInstance().getExternalContext().getSessionMap();
if (sessionMap != null) {
ufb = new UserFormBean();
ufb.setId(id);
try {
Session hSession = HibernateHelper.openSession();
user = (User)hSession.get(User.class, id);
HibernateHelper.closeSession();
} catch (Exception e) {
FacesContext context = FacesContext.getCurrentInstance();
context.addMessage(null, new
FacesMessage(FacesMessage.SEVERITY_ERROR,e.toString(), null));
return "failed";
}
if (user==null || !user.getId().equals(id)) {
user = new User();
user.setId(id);
sessionMap.put("user", user);
} else {
// fill UserFormBean with user information
loadUser(ufb,user);
actionResult="greeting";
}
sessionMap.put("UserFormBean", ufb);
}
return actionResult;
}
private void loadUser(UserFormBean userForm,User user) {
userForm.setId(user.getId());
userForm.setFirstName(user.getFirstName());
userForm.setLastName(user.getLastName());
userForm.setEmail(user.getEmail());
userForm.setStreet(user.getAddress().getStreet());
userForm.setCity(user.getAddress().getCity());
userForm.setState(user.getAddress().getState());
userForm.setZip(user.getAddress().getZip());
}
</pre><div class="orderedlist"><ol start="27" type="1"><li><p>Modify the UserFormBean.java class in JavaSource/demo by adding these
 imports:</p></li></ol></div><pre class="programlisting">import org.hibernate.Session;
import org.hibernate.Transaction;
</pre><div class="orderedlist"><ol start="28" type="1"><li><p>Then, replace the save() method with this code and save the class.</p></li></ol></div><pre class="programlisting">public String save() throws Exception {
Map sessionMap =
FacesContext.getCurrentInstance().getExternalContext().getSessionMap();
if (sessionMap != null) {
UserFormBean ufb=(UserFormBean)sessionMap.get("UserFormBean");
try {
Session hSession = HibernateHelper.openSession();
Transaction tran = hSession.beginTransaction();
User user = (User)hSession.get(User.class, id);
if (user == null) {
user = new User();
user.setId(id);
hSession.save(user);
}
saveUser(ufb, user);
tran.commit();
HibernateHelper.closeSession();
} catch (Exception e) {
return "failed";
}
}
return "greeting";
}
</pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="SettinguptheDatabase"></a>5.9.&nbsp;Setting up the Database</h2></div></div><div></div></div><p>To set up the database end, we need to use Red Hat Developer Studio and our HSQL database engine to create a 
database table corresponding to the class we are trying to persist and make the database available.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="CreatingtheDatabaseTable"></a>5.10.&nbsp;Creating the Database Table</h2></div></div><div></div></div><p>Let's first create the script for our database table in Red Hat Developer Studio.</p><div class="orderedlist"><ol start="29" type="1"><li><p>In the ORM Explorer view, right-click on JavaSource/hibernate.cfg.xml and select "Generate DDL Wizard".</p></li><li><p>Select HSQL as the Dialect and leave Location as is.</p></li><li><p>Click Finish.</p></li></ol></div><p>A DDL file called schema.sql will be created in the root of the project and will be opened in an
 editor window.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="MakingTheDatabaseAvailableForTheApplication"></a>5.11.&nbsp;Making the Database Available for the Application</h2></div></div><div></div></div><p>The databse server, HSQLDB, is provided with the project. It's located in the ormHibernate3-jsf/hsqldb folder.</p><div class="orderedlist"><ol start="32" type="1"><li><p>Start the database server: .../ormHibernate3-jsf/hsqldb/bin/server.bat</p></li><li><p>In a separate window, start the admin tool: .../ormHibernate3-jsf/hsqldb/bin/dbadmin.bat</p></li></ol></div><p>This will launch a small GUI application, HSQL Database Manager.</p><div class="orderedlist"><ol start="34" type="1"><li><p>Leave all values as they are, only change URL: to the following: jdbc:hsqldb:hsql://localhost</p></li><li><p>Click OK.</p></li><li><p>Select File/Open Script... from the menu bar of HSQL Database Manager.</p></li><li><p>Find and open the the DDL file we just created.</p></li><li><p>Click Execute back in the main screen of the Database Manager.</p></li><li><p>38. Select View/Refresh Tree from the menu bar.</p></li></ol></div><p>The User database should now appear in the expand/collapse tree to the left.</p><div class="orderedlist"><ol start="40" type="1"><li><p>Select File/Exit from the menu bar.</p></li><li><p>Stop the database server: .../ormHibernate3-jsf/hsqldb/bin/shutdown.bat</p></li></ol></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="SettinguptheApplicationServer"></a>5.12.&nbsp;Setting up the Application Server</h2></div></div><div></div></div><p>Finally, we need to set up the application server before we can run the database-enabled
application in a Web browser. To do this, we'll need to modify the application context in the-
Tomcat server.xml file.</p><div class="orderedlist"><ol start="42" type="1"><li><p>Stop the Tomcat server, if it's running.</p></li><li><p>Locate the server.xml file in the Package Explorer view under the Tomcat Server
node under Servers.</p></li><li><p>Double-click the file to open an editor on it.</p></li><li><p>Find the Context tag for your application in the file. It will have a path attribute
with a value of /ormHibernate3-jsf.</p></li></ol></div><p>You'll need to convert this "empty" XML element into one with beginning and ending tags,
so we can insert the special resource tags for Tomcat to run this application with a database.</p><div class="orderedlist"><ol start="46" type="1"><li><p>Delete the closing slash at the end of the Context tag.</p></li><li><p>Insert a blank line after the tag and then start another line.</p></li><li><p>On this line, insert a closing tag:</p></li></ol></div><pre class="programlisting">&lt;/Context&gt;
</pre><div class="orderedlist"><ol start="49" type="1"><li><p>On the blank line between the starting and ending tags, add the following resource definition coding.</p></li></ol></div><pre class="programlisting">&lt;Resource name="jdbc/kickstart" scope="Shareable"
type="javax.sql.DataSource"/&gt;
&lt;ResourceParams name="jdbc/kickstart"&gt;
&lt;parameter&gt;
&lt;name&gt;factory&lt;/name&gt;
&lt;value&gt;org.apache.commons.dbcp.BasicDataSourceFactory&lt;/
value&gt;
&lt;/parameter&gt;
&lt;parameter&gt;
&lt;name&gt;url&lt;/name&gt;
&lt;value&gt;jdbc:hsqldb:hsql://localhost&lt;/value&gt;
&lt;/parameter&gt;
&lt;parameter&gt;
&lt;name&gt;driverClassName&lt;/name&gt;
&lt;value&gt;org.hsqldb.jdbcDriver&lt;/value&gt;
&lt;/parameter&gt;
&lt;parameter&gt;
&lt;name&gt;username&lt;/name&gt;
&lt;value&gt;sa&lt;/value&gt;
&lt;/parameter&gt;
&lt;parameter&gt;
&lt;name&gt;password&lt;/name&gt;
&lt;value&gt;&lt;/value&gt;
&lt;/parameter&gt;
&lt;parameter&gt;
&lt;name&gt;maxWait&lt;/name&gt;
&lt;value&gt;3000&lt;/value&gt;
&lt;/parameter&gt;
&lt;parameter&gt;
&lt;name&gt;maxIdle&lt;/name&gt;
&lt;value&gt;100&lt;/value&gt;
&lt;/parameter&gt;
&lt;parameter&gt;
&lt;name&gt;maxActive&lt;/name&gt;
&lt;value&gt;10&lt;/value&gt;
&lt;/parameter&gt;
&lt;/ResourceParams&gt;
</pre><div class="orderedlist"><ol start="50" type="1"><li><p>Finally, copy .../ormHibernate3-jsf/hsqldb/lib/hsqldb.jar to your
Tomcat .../common/lib folder.</p></li></ol></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="RunningOurNewApplication"></a>5.13.&nbsp;Running Our New Application</h2></div></div><div></div></div><div class="orderedlist"><ol start="51" type="1"><li><p>Start the database server: .../ormHibernate3-jsf/hsqldb/bin/server.bat</p></li><li><p>Start the Tomcat server.</p></li><li><p>Run the application.</p></li></ol></div><p>Play with the application. Restart Tomcat and the database server. If you run the application
again and enter a user that you already saved, the application should retrieve it from the database
and display its details.</p></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="GettingStartedStrutsValidationExamples.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="index.html">Up</a></td><td width="40%" align="right">&nbsp;</td></tr><tr><td width="40%" align="left" valign="top">Chapter&nbsp;4.&nbsp;Getting Started Struts Validation Examples&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;</td></tr></table></div></body></html>